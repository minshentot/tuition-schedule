<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Ooi Tuition è¡¥ä¹ èµ„è®¯ æœç´¢ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #f8fafc 0, #e0f2fe 40%, #eef2ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #0f172a;
    }

    .container {
      width: 100%;
      max-width: 960px;
      background: #ffffffee;
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.16);
      padding: 24px 20px 28px;
      backdrop-filter: blur(10px);
    }

    @media (min-width: 768px) {
      .container {
        padding: 28px 32px 32px;
      }
    }

    .title {
      text-align: center;
      margin-bottom: 6px;
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      font-weight: 800;
      letter-spacing: 0.04em;
      background: linear-gradient(120deg, #0f172a, #1d4ed8, #0ea5e9);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      text-align: center;
      font-size: 0.88rem;
      color: #64748b;
      margin-bottom: 20px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0f172a;
      font-size: 0.78rem;
      margin-bottom: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .section {
      margin-top: 18px;
    }

    .card {
      border-radius: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 16px 14px 18px;
    }

    @media (min-width: 768px) {
      .card {
        padding: 18px 18px 20px;
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-weight: 700;
      font-size: 0.98rem;
      color: #0f172a;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: #94a3b8;
    }

    label {
      font-size: 0.85rem;
      color: #0f172a;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }

    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input[type="password"]:focus, input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      margin-top: 8px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease, box-shadow 0.12s ease, opacity 0.15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45);
      opacity: 0.96;
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 5px 12px rgba(37, 99, 235, 0.35);
    }

    .btn-ghost {
      background: transparent;
      color: #64748b;
      box-shadow: none;
      padding-inline: 10px;
      margin-top: 0;
      border: none;
      cursor: pointer;
      font-size: 0.82rem;
    }

    .btn-ghost:hover {
      background: #e2e8f0;
      box-shadow: none;
      transform: none;
    }

    .helper-text {
      font-size: 0.78rem;
      color: #94a3b8;
      margin-top: 4px;
      line-height: 1.5;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .message-error {
      color: #b91c1c;
    }

    .hidden {
      display: none !important;
    }

    .hint-list {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 6px;
      list-style: disc;
      padding-left: 16px;
    }

    .hint-list li + li {
      margin-top: 2px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #2563eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      color: white;
    }

    .parent-tip {
      font-size: 0.82rem;
      color: #4b5563;
      background: #fefce8;
      border: 1px solid #facc15;
      border-radius: 12px;
      padding: 10px 10px;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .parent-tip strong {
      color: #854d0e;
    }

    .info-line {
      font-size: 0.86rem;
      margin-bottom: 4px;
      color: #111827;
    }

    .info-line span {
      font-weight: 600;
      color: #1d4ed8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    thead {
      background: #e5effe;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 700;
      color: #1f2937;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .tag {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag-subject {
  background: #f3e8ff; 
  color: #7e22ce;     
    }

    .small-note {
      font-size: 0.74rem;
      color: #94a3b8;
      margin-top: 8px;
    }

    .admin-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 900px) {
      .admin-layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .admin-left {
        flex: 0 0 260px;
      }
      .admin-right {
        flex: 1;
      }
    }

    .admin-note-list {
      font-size: 0.8rem;
      color: #4b5563;
      padding-left: 16px;
      list-style: decimal;
      margin-top: 6px;
    }

    .admin-note-list li + li {
      margin-top: 4px;
    }

    details {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    details summary {
      cursor: pointer;
      color: #2563eb;
      font-weight: 600;
      list-style: none;
    }

    details[open] summary {
      margin-bottom: 4px;
    }

    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
    }

    .search-input input {
      width: 100%;
    }

    .no-data {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 8px;
      text-align: center;
    }

    .highlight-name {
      font-weight: 700;
      color: #0f172a;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="badge">
    <span class="badge-dot"></span>
    Teacher Ooi Tuition â€¢ è¡¥ä¹ æ—¶é—´ & åŠŸè¯¾æŸ¥è¯¢
  </div>
  <h1 class="title">Teacher Ooi Tuition è¡¥ä¹ èµ„è®¯ æœç´¢ç³»ç»Ÿ</h1>
  <p class="subtitle">è¯·è¾“å…¥è€å¸ˆæä¾›çš„ access codeï¼Œä»¥æŸ¥çœ‹è¡¥ä¹ æ—¶é—´ã€ç§‘ç›®ä¸åŠŸè¯¾å®‰æ’</p>

  <!-- ç™»å½•åŒºåŸŸ -->
  <section id="loginSection" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">è¯·è¾“å…¥ Access Code</div>
          <div class="card-subtitle">å­¦ç”Ÿ / å®¶é•¿è¯·ä½¿ç”¨è€å¸ˆç»™ä½ çš„ä¸“å± access code</div>
        </div>
      </div>

      <label for="accessCode">Access Code</label>
      <input id="accessCode" type="password" placeholder="åœ¨è¿™é‡Œè¾“å…¥ access codeï¼Œç„¶åæŒ‰ Enter æˆ–æŒ‰é’®" />
      <button class="btn" onclick="handleLogin()">
        è¿›å…¥è¡¥ä¹ èµ„è®¯
      </button>

      <div id="loginMessage" class="message"></div>

      <ul class="hint-list">
        <li>æ¯ä½å­¦ç”Ÿ / å®¶é•¿éƒ½æœ‰ä¸ªäººä¸“å± access codeã€‚</li>
        <li>å¦‚å¿˜è®°æˆ–é—å¤±ï¼Œè¯·ç›´æ¥å‘è€å¸ˆç´¢å–æ–°çš„ access codeã€‚</li>
      </ul>
      <p class="helper-text">
        æ¸©é¦¨æé†’ï¼šæœ¬ç³»ç»Ÿåªè´Ÿè´£æ˜¾ç¤ºæ’è¯¾ä¸åŠŸè¯¾èµ„è®¯ï¼Œä¸ä¼šåœ¨ç”»é¢ä¸Šæ˜¾ç¤ºä»»ä½• access code è¯¦æƒ…ï¼Œä»¥ä¿æŠ¤æ‰€æœ‰å­¦ç”Ÿä¸å®¶åº­çš„éšç§ã€‚
      </p>
    </div>
  </section>

  <!-- ä¸»å†…å®¹åŒºåŸŸï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <section id="mainSection" class="section hidden">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title" id="welcomeTitle"></div>
          <div class="card-subtitle" id="welcomeSubtitle"></div>
        </div>
        <button class="btn-ghost" onclick="handleLogout()">é€€å‡º / åˆ‡æ¢è´¦å·</button>
      </div>

      <!-- å­¦ç”Ÿ / å®¶é•¿è§†å›¾ -->
      <div id="studentView" class="hidden">
        <div class="section-title">
          <span class="icon">âœ“</span>
          <span>ç»™å®¶é•¿ / å­¦ç”Ÿçš„å°æé†’</span>
        </div>

        <div class="parent-tip">
          <strong>æ¸©é¦¨æé†’ï¼š</strong>
          æ¬¢è¿æ¥åˆ° <strong>Teacher Ooi Tuition è¡¥ä¹ èµ„è®¯æœç´¢ç³»ç»Ÿ</strong>ã€‚ä»¥ä¸‹æ˜¯
          <span id="studentNameInTip" class="highlight-name"></span>
          è¿‘æœŸçš„è¡¥ä¹ æ—¶é—´ä¸ç§‘ç›®å®‰æ’ã€‚<br><br>
          è€å¸ˆè‹¥æœ‰ä¸´æ—¶è°ƒæ•´ï¼ˆæ—¶é—´å˜åŠ¨ã€åŠ è¯¾ã€æ”¹ç§‘ç›®ï¼‰ï¼Œä¼šåœ¨è¿™é‡Œæ›´æ–°ï¼Œè¯·å®¶é•¿ï¼š<br>
          â€¢ å»ºè®®æ¯å‘¨è‡³å°‘æŸ¥çœ‹ä¸€æ¬¡ï¼›<br>
          â€¢ å¦‚å¯¹æ—¶é—´æˆ–åŠŸè¯¾æœ‰ç–‘é—®ï¼Œæ¬¢è¿ç›´æ¥ WhatsApp è€å¸ˆç¡®è®¤ï¼›<br>
          â€¢ è‹¥å­¦ç”Ÿå½“å¤©èº«ä½“ä¸é€‚æˆ–æœ‰é‡è¦æ´»åŠ¨ï¼Œè¯·å°½æ—©é€šçŸ¥è€å¸ˆï¼Œä»¥ä¾¿å®‰æ’è¡¥è¯¾ã€‚
        </div>

        <div class="info-line">
          å½“å‰ç™»å…¥å­¦ç”Ÿï¼š<span id="studentFullName"></span>
        </div>

        <table id="studentTable">
          <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>æ˜ŸæœŸ</th>
            <th>æ—¶é—´</th>
            <th>åœ°ç‚¹</th>
            <th>ç§‘ç›®</th>
            <th>åŠŸè¯¾ / ä½œä¸š</th>
            <th>å¤‡æ³¨</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="studentNoData" class="no-data hidden">
          ç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°å±äºè¯¥å­¦ç”Ÿçš„è¡¥ä¹ å®‰æ’ï¼Œè¯·ç¨åå†æŸ¥çœ‹æˆ–è”ç»œè€å¸ˆã€‚
        </div>
        <p class="small-note">
          æç¤ºï¼šè‹¥æœ‰è€ƒè¯•å‰åŠ è¯¾ã€è¡¥è¯¾å®‰æ’ï¼Œè¯·ç‰¹åˆ«ç•™æ„ã€Œå¤‡æ³¨ã€æ ã€‚
        </p>
      </div>

      <!-- Admin è§†å›¾ï¼ˆåªæœ‰çŸ¥é“ admin code çš„äººæ‰è¿›å¾—åˆ°ï¼‰ -->
      <div id="adminView" class="hidden">
        <div class="admin-layout">
          <div class="admin-left">
            <div class="section-title">
              <span class="icon">A</span>
              <span>è€å¸ˆä¸“ç”¨æ’è¯¾æ€»è§ˆ</span>
            </div>
            <p class="info-line">
              å½“å‰æ¨¡å¼ï¼š<span style="font-weight:700;color:#1d4ed8;">è€å¸ˆç®¡ç†æ¨¡å¼ï¼ˆAdminï¼‰</span>
            </p>
            <p class="info-line" style="margin-top:4px;">
              æœ¬é¡µé¢æ‰€æœ‰æ’è¯¾èµ„æ–™ï¼Œéƒ½æ˜¯ç”±è€å¸ˆåœ¨ Google Sheet ä¸­ç¼–è¾‘ï¼Œç½‘é¡µä¼šè‡ªåŠ¨åŒæ­¥æœ€æ–°èµ„è®¯ã€‚
            </p>

            <details>
              <summary>ğŸ“± æ‰‹æœºä¸Šå¿«é€Ÿä¿®æ”¹æ—¶é—´è¡¨ï¼ˆç»™è€å¸ˆï¼‰</summary>
              <ol class="admin-note-list">
                <li>æ‰“å¼€ Google Sheetï¼ˆç”¨ä½ çš„ Gmail å¸å·ç™»å…¥ï¼‰ã€‚</li>
                <li>æ‰¾åˆ°è¿™å¼ æ—¶é—´è¡¨ï¼Œç›´æ¥ä¿®æ”¹æ—¥æœŸ / æ—¶é—´ / å­¦ç”Ÿåå• / ç§‘ç›® / åŠŸè¯¾ / å¤‡æ³¨ã€‚</li>
                <li>Sheet è‡ªåŠ¨å‚¨å­˜ï¼Œä¸ç”¨æŒ‰ä¿å­˜ã€‚</li>
                <li>å®¶é•¿åˆ·æ–°ç½‘é¡µåï¼Œå°±ä¼šçœ‹åˆ°æœ€æ–°çš„æ’è¯¾ã€‚</li>
              </ol>
            </details>

            <details>
              <summary>ğŸ“ æ›´æ”¹ access code / æ–°å¢å­¦ç”Ÿï¼ˆç»™è€å¸ˆï¼‰</summary>
              <ul class="admin-note-list">
                <li>access code ä¾ç„¶å†™åœ¨ç½‘é¡µä»£ç çš„ <code>ACCESS_CODES</code> é‡Œé¢ã€‚</li>
                <li><code>shortName</code> è¦è·Ÿ Google Sheet çš„ã€Œstudentsã€æ é‡Œç”¨çš„åå­—ä¸€è‡´ï¼ˆä¾‹å¦‚ "Lucas"ï¼‰ã€‚</li>
                <li>è¦æ¢ access codeï¼šåªæ”¹è¯¥å­¦ç”Ÿé‚£ä¸€æ®µçš„ <code>code: "â€¦â€¦"</code>ã€‚</li>
                <li>è¦åŠ æ–°å­¦ç”Ÿï¼šå¤åˆ¶ä¸€å°æ®µï¼Œæ”¹åå­—å’Œ code å³å¯ã€‚</li>
              </ul>
            </details>
          </div>

          <div class="admin-right">
            <div class="card-subtitle" style="margin-bottom:6px;">å®Œæ•´æ’è¯¾æ€»è§ˆï¼ˆä»…è€å¸ˆçœ‹å¾—åˆ°ï¼‰</div>
            <div class="search-row">
              <div class="search-input">
                <input id="adminSearch" type="text" placeholder="å¿«é€Ÿæœç´¢ï¼šå­¦ç”Ÿåå­— / ç§‘ç›® / æ—¥æœŸ å…³é”®å­—â€¦" oninput="filterAdminTable()" />
              </div>
              <span class="small-note">ä¾‹å¦‚ï¼š<code>Lucas</code>ã€<code>æ•°å­¦</code>ã€<code>12æœˆ7æ—¥</code></span>
            </div>

            <table id="adminTable">
              <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>æ˜ŸæœŸ</th>
                <th>æ—¶é—´</th>
                <th>åœ°ç‚¹</th>
                <th>å­¦ç”Ÿ</th>
                <th>ç§‘ç›®</th>
                <th>åŠŸè¯¾ / ä½œä¸š</th>
                <th>å¤‡æ³¨</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="adminNoData" class="no-data hidden">
              ç›®å‰è¿˜æ²¡æœ‰è½½å…¥ä»»ä½•æ—¶é—´è¡¨èµ„æ–™ï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ Google Sheet è®¾å®šã€‚
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<script>
  // ============================
  // 0. Google Sheet CSV ä½ç½®ï¼ˆä½ çš„åå°ï¼‰
  // ============================
  // å¦‚æœå°†æ¥æ¢æ–° Sheetï¼Œåªè¦æŠŠä¸‹é¢è¿™æ¡ link æ¢æ‰å°±å¯ä»¥ï¼š
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQY9srKI-EAsARYyhifRknDi3qcDdV-wY7AfQdG6Clx12Dtmp2A0ffCpAizDEZU_Kz6_A7ugfLIRuoY/pub?output=csv";

  // ============================
  // 1. è®¾å®š Access Code å’Œå­¦ç”Ÿèµ„æ–™
  // ============================

  const ACCESS_CODES = {
    // è€å¸ˆçš„ admin codeï¼ˆåªç»™ä½ è‡ªå·±çŸ¥é“ï¼Œä¸ä¼šå‡ºç°åœ¨ç”»é¢æ–‡å­—ï¼‰
    "totadmin2024": {
      role: "admin",
      fullName: "Teacher Ooi",
      shortName: "ADMIN",
      code: "totadmin2024"
    },

    // å­¦ç”Ÿ / å®¶é•¿è´¦å·
    "LGCZ3690": {
      role: "student",
      fullName: "Lucas Goh Cheng Ze",
      shortName: "Lucas",
      code: "LGCZ3690"
    },
    "JGJQ3620": {
      role: "student",
      fullName: "Joey Goh Jia Qi",
      shortName: "Joey",
      code: "JGJQ3620"
    },
    "JKJW5791": {
      role: "student",
      fullName: "Jayden Kang Jia Wei",
      shortName: "Jayden",
      code: "JKJW5791"
    },
    "WO8765": {
      role: "student",
      fullName: "Wendy Ong",
      shortName: "Wendy",
      code: "WO8765"
    },
    "GYC3628": {
      role: "student",
      fullName: "Goh Yu Chen",
      shortName: "Yu Chen",
      code: "GYC3628"
    },
    "GYS4782": {
      role: "student",
      fullName: "Goh Yu Sen",
      shortName: "Yu Sen",
      code: "GYS4782"
    },
    "EAHY8297": {
      role: "student",
      fullName: "Emily Ang Hui Yin",
      shortName: "Emily",
      code: "EAHY8297"
    },
    "CYX6969": {
      role: "student",
      fullName: "Choo Yi Xuan",
      shortName: "Yi Xuan",
      code: "CYX6969"
    },
    "CYH6699": {
      role: "student",
      fullName: "Choo Yan Han",
      shortName: "Yan Han",
      code: "CYH6699"
    }
  };

  // ============================
  // 2. ä» Google Sheet è½½å…¥æ—¶é—´è¡¨
  // ============================

  let SCHEDULE = [];
  let scheduleLoaded = false;
  let scheduleError = false;

  function parseCSV(text) {
    const rows = text.trim().split(/\r?\n/);
    if (!rows.length) return [];

    const dataRows = rows.slice(1); // ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜

    const result = [];

    for (const row of dataRows) {
      const fields = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < row.length; i++) {
        const ch = row[i];

        if (ch === '"') {
          // åˆ‡æ¢å¼•å·çŠ¶æ€
          inQuotes = !inQuotes;
        } else if (ch === "," && !inQuotes) {
          // åœ¨éå¼•å·çŠ¶æ€ä¸‹é‡åˆ°é€—å· â†’ åˆ†éš”å­—æ®µ
          fields.push(field);
          field = "";
        } else {
          field += ch;
        }
      }
      fields.push(field);

      // é¢„æœŸæ ä½ï¼šdate, day, time, location, students, subject, homework, remark
      const [
        date,
        day,
        time,
        location,
        studentsStr,
        subject,
        homework,
        remark
      ] = fields.map((f) => (f || "").trim());

      if (!date && !subject && !studentsStr) continue; // ç©ºè¡Œè·³è¿‡

      const students = studentsStr
        ? studentsStr.split(/[,ï¼Œ]/).map((s) => s.trim()).filter(Boolean)
        : [];

      result.push({
        date: date || "",
        dateLabel: date || "",
        day: day || "",
        time: time || "",
        location: location || "",
        students,
        subject: subject || "",
        homework: homework || "",
        remark: remark || ""
      });
    }
    return result;
  }

  function loadSchedule() {
    fetch(CSV_URL)
      .then((res) => {
        if (!res.ok) {
          throw new Error("è½½å…¥å¤±è´¥");
        }
        return res.text();
      })
      .then((text) => {
        SCHEDULE = parseCSV(text);
        scheduleLoaded = true;
        scheduleError = false;
      })
      .catch((err) => {
        console.error("è½½å…¥æ—¶é—´è¡¨å¤±è´¥ï¼š", err);
        scheduleLoaded = true;
        scheduleError = true;
      });
  }

  loadSchedule();

  // ============================
  // 3. ç™»å½•ä¸ç”»é¢åˆ‡æ¢é€»è¾‘
  // ============================

  function normalizeName(name) {
    return (name || "").toLowerCase().replace(/\s+/g, "");
  }

  function handleLogin() {
    const input = document.getElementById("accessCode");
    const code = (input.value || "").trim();
    const msg = document.getElementById("loginMessage");

    if (!code) {
      msg.textContent = "è¯·è¾“å…¥ access codeã€‚";
      msg.className = "message message-error";
      return;
    }

    const user = ACCESS_CODES[code];

    if (!user) {
      msg.textContent = "Access code ä¸æ­£ç¡®ï¼Œè¯·ç¡®è®¤åå†è¾“å…¥ã€‚";
      msg.className = "message message-error";
      return;
    }

    if (!scheduleLoaded) {
      msg.textContent = "ç³»ç»Ÿæ­£åœ¨è½½å…¥æœ€æ–°æ—¶é—´è¡¨ï¼Œè¯·ç¨å€™å‡ ç§’å†å°è¯•ã€‚";
      msg.className = "message message-error";
      return;
    }

    if (scheduleError) {
      msg.textContent = "æ—¶é—´è¡¨è½½å…¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»è€å¸ˆæ£€æŸ¥ Google Sheet è®¾å®šã€‚";
      msg.className = "message message-error";
      return;
    }

    // æ¸…é™¤æç¤º
    msg.textContent = "";
    msg.className = "message";

    // åˆ‡æ¢åˆ°ä¸»ç”»é¢
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("mainSection").classList.remove("hidden");

    const welcomeTitle = document.getElementById("welcomeTitle");
    const welcomeSubtitle = document.getElementById("welcomeSubtitle");

    if (user.role === "admin") {
      welcomeTitle.textContent = "æ¬¢è¿ä½¿ç”¨æ’è¯¾ç®¡ç†ç³»ç»Ÿ";
      welcomeSubtitle.textContent = "ç›®å‰æ˜¯è€å¸ˆç®¡ç†æ¨¡å¼ï¼Œä»¥ä¸‹ä¸ºå…¨éƒ¨å­¦ç”Ÿçš„è¡¥ä¹ å®‰æ’æ€»è§ˆã€‚";
      document.getElementById("studentView").classList.add("hidden");
      document.getElementById("adminView").classList.remove("hidden");
      renderAdminTable();
    } else {
      welcomeTitle.textContent = `æ¬¢è¿ï¼Œ${user.fullName}`;
      welcomeSubtitle.textContent = "ä»¥ä¸‹æ˜¯ä¸“å±ä½ çš„è¡¥ä¹ æ—¶é—´ä¸ç§‘ç›®å®‰æ’ã€‚";
      document.getElementById("studentView").classList.remove("hidden");
      document.getElementById("adminView").classList.add("hidden");
      renderStudentView(user);
    }
  }

  function handleLogout() {
    document.getElementById("mainSection").classList.add("hidden");
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("accessCode").value = "";
    document.getElementById("loginMessage").textContent = "";
    const search = document.getElementById("adminSearch");
    if (search) search.value = "";
  }

  // æŒ‰ Enter ä¹Ÿèƒ½ç™»å½•
  document.getElementById("accessCode")
    .addEventListener("keyup", function (event) {
      if (event.key === "Enter") {
        handleLogin();
      }
    });

  // ============================
  // 4. å­¦ç”Ÿ / Admin ç”»é¢æ¸²æŸ“
  // ============================

  function renderStudentView(user) {
    const tbody = document.querySelector("#studentTable tbody");
    tbody.innerHTML = "";
    const noData = document.getElementById("studentNoData");

    document.getElementById("studentNameInTip").textContent = user.fullName;
    document.getElementById("studentFullName").textContent = user.fullName;

    if (!SCHEDULE.length) {
      noData.classList.remove("hidden");
      noData.textContent = "ç›®å‰æ—¶é—´è¡¨å°šæœªè®¾å®šï¼Œè¯·ç¨åå†æŸ¥çœ‹æˆ–è”ç»œè€å¸ˆã€‚";
      return;
    } else {
      noData.classList.add("hidden");
    }

    const shortKey = normalizeName(user.shortName);

    const rows = SCHEDULE.filter((item) =>
      item.students.some((s) => normalizeName(s) === shortKey)
    );

    if (!rows.length) {
      noData.classList.remove("hidden");
      noData.textContent = "ç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°å±äºè¯¥å­¦ç”Ÿçš„è¡¥ä¹ å®‰æ’ï¼Œè¯·ç¨åå†æŸ¥çœ‹æˆ–è”ç»œè€å¸ˆã€‚";
      return;
    } else {
      noData.classList.add("hidden");
    }

    rows
      .sort((a, b) => {
        if (a.date === b.date) {
          return a.time.localeCompare(b.time);
        }
        return a.date.localeCompare(b.date);
      })
      .forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.dateLabel}</td>
          <td>${item.day}</td>
          <td>${item.time}</td>
          <td>${item.location}</td>
          <td><span class="tag tag-subject">${item.subject}</span></td>
          <td>${item.homework || "<span style='color:#9ca3af;'>ï¼ˆæš‚æ— èµ„æ–™ï¼‰</span>"}</td>
          <td>${item.remark || ""}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  function renderAdminTable() {
    const tbody = document.querySelector("#adminTable tbody");
    tbody.innerHTML = "";

    const noData = document.getElementById("adminNoData");

    if (!SCHEDULE.length) {
      noData.classList.remove("hidden");
      noData.textContent = "ç›®å‰æ—¶é—´è¡¨å°šæœªè®¾å®šï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ Google Sheetã€‚";
      return;
    } else {
      noData.classList.add("hidden");
    }

    const rows = [...SCHEDULE].sort((a, b) => {
      if (a.date === b.date) {
        return a.time.localeCompare(b.time);
      }
      return a.date.localeCompare(b.date);
    });

    rows.forEach((item) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.dateLabel}</td>
        <td>${item.day}</td>
        <td>${item.time}</td>
        <td>${item.location}</td>
        <td>${item.students.join("ã€")}</td>
        <td><span class="tag tag-subject">${item.subject}</span></td>
        <td>${item.homework || "<span style='color:#9ca3af;'>ï¼ˆæš‚æ— ï¼‰</span>"}</td>
        <td>${item.remark || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function filterAdminTable() {
    const searchInput = document.getElementById("adminSearch");
    if (!searchInput) return;
    const keyword = (searchInput.value || "").toLowerCase().trim();
    const tbody = document.querySelector("#adminTable tbody");
    const rows = tbody.querySelectorAll("tr");
    let visibleCount = 0;

    rows.forEach((tr) => {
      const text = tr.textContent.toLowerCase();
      if (!keyword || text.includes(keyword)) {
        tr.style.display = "";
        visibleCount++;
      } else {
        tr.style.display = "none";
      }
    });

    const noData = document.getElementById("adminNoData");
    if (visibleCount === 0) {
      noData.classList.remove("hidden");
      noData.textContent = "æ²¡æœ‰ç¬¦åˆæœç´¢æ¡ä»¶çš„è®°å½•ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®å­—ã€‚";
    } else {
      noData.classList.add("hidden");
    }
  }
</script>
</body>
</html>

